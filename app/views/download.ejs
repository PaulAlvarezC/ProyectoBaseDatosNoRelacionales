<%- include('include/_header') %>

    <style>
        html2canvas {
            width: 300px !important;
            height: 200px !important;
        }
    </style>
    <main id="site-main">
        <div class="container">
            <div class="box-nav d-flex justify-between">
                <div class="filter">
                    <a href="/"><i class="fas fa-angle-double-left"></i> REGRESAR</a>
                </div>
            </div>
            <div class="form-title text-center">
                <h2 class="text-dark">Descargar carnet de vacunación</h2>
            </div>

            <form method="POST" id="download" hidden>
                <div class="new_user">
                    <div class="row">
                        <div class="form-group column">
                            <label for="ci" class="text-light">Cédula</label>
                            <input type="hidden" name="id" value="<%= user._id %>">
                            <input type="text" name="ci" value="<%= user.ci %>" placeholder="" disabled>
                        </div>
                        <div class="form-group column" style="margin-left: 10px;">
                            <label for="nombres" class="text-light">Nombres</label>
                            <input type="text" name="nombres" value="<%= user.nombres %>" placeholder="">
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group column">
                            <label for="centro" class="text-light">Centro de Vacunación</label>
                            <input type="text" name="centro" value="<%= user.centro %>" placeholder="">
                        </div>
                        <div class="form-group column" style="margin-left: 10px;">
                            <label for="edad" class="text-light">Edad</label>
                            <input name="edad" value="<%= user.edad %>" placeholder=""
                                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                type = "number"
                                maxlength = "2"
                            >
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vacuna" class="text-light">Vacuna: </label><br>
                        <div class="radio inline">
                            <input type="radio" id="radio-2" name="vacuna" value="Pfizer" <%=user.vacuna=='Pfizer' ? 'checked' : '' %>>
                            <label for="radio-2" class="radio-label">Pfizer</label>
                        </div>
                        <div class="radio inline">
                            <input type="radio" id="radio-3" name="vacuna" value="Sinovak" <%=user.vacuna=='Sinovak' ? 'checked' : '' %>>
                            <label for="radio-3" class="radio-label">Sinovak</label>
                        </div>
                        <div class="radio inline">
                            <input type="radio" id="radio-4" name="vacuna" value="Astrazeneca" <%=user.vacuna=='Astrazeneca' ? 'checked' : '' %>>
                            <label for="radio-4" class="radio-label">Astrazeneca</label>
                        </div>
                        <div class="radio inline">
                            <input type="radio" id="radio-5" name="vacuna" value="Johnson & Johnson" <%=user.vacuna=='Johnson & Johnson' ? 'checked' : '' %>>
                            <label for="radio-5" class="radio-label">Johnson & Johnson</label>
                        </div>
                        <div class="radio inline">
                            <input type="radio" id="radio-6" name="vacuna" value="Moderna" <%=user.vacuna=='Moderna' ? 'checked' : '' %>>
                            <label for="radio-6" class="radio-label">Moderna</label>
                        </div>
                        <div class="radio inline">
                            <input type="radio" id="radio-7" name="vacuna" value="Sputnik" <%=user.vacuna=='Sputnik' ? 'checked' : '' %>>
                            <label for="radio-7" class="radio-label">Sputnik</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group columna">
                            <label for="fechaPrimeraDosis" class="text-light">Primera Dosis</label>
                            <input type="text" name="fechaPrimeraDosis" value="<%= user.fechaPrimeraDosis %>" placeholder="" disabled>
                        </div>
                        <div class="form-group columna" style="margin-left: 10px;">
                            <label for="vacunadorPrimeraDosis" class="text-light">Vacunador Primera Dosis</label>
                            <input type="text" name="vacunadorPrimeraDosis" value="<%= user.vacunadorPrimeraDosis %>" placeholder="">
                        </div>
                        <div class="form-group columna" style="margin-left: 10px;">
                            <label for="lotePrimeraDosis" class="text-light">Lote primera dosis</label>
                            <input type="text" name="lotePrimeraDosis" value="<%= user.lotePrimeraDosis %>" placeholder="">
                        </div>
                    </div>
            
                    <div class="row" id = "GFG_UP">
                        <div class="form-group columna">
                            <label for="fechaSegundaDosis" class="text-light">Segunda Dosis</label>
                            <input type="text" name="fechaSegundaDosis" value="<%= user.fechaSegundaDosis %>" placeholder="" >
                        </div>
                        <div class="form-group columna" style="margin-left: 10px;">
                            <label for="vacunadorSegundaDosis" class="text-light">Vacunador Segunda Dosis</label>
                            <input type="text" name="vacunadorSegundaDosis" value="<%= user.vacunadorSegundaDosis %>" placeholder="">
                        </div>
                        <div class="form-group columna" style="margin-left: 10px;">
                            <label for="loteSegundaDosis" class="text-light">Lote segunda dosis</label>
                            <input type="text" name="loteSegundaDosis" value="<%= user.loteSegundaDosis %>" placeholder="">
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn text-dark update">Actualizar</button>
                    </div>
                </div>
            </form>
            <center>
                <div id="my-node" style="width: 700px; height: 400px; background-color: rgb(230, 230, 230); border-radius: 5px;">
                    <h2 style="padding-top: 20px;">CARNET DE VACUNACIÓN CONTRA LA COVID-19</h2>
                    <br>
                    <div class="row">
                        <div class="form-group columna">
                            <label>Centro vacunación:</label>
                        </div>
                        <div class="form-group columna">
                            <label>Edad:</label>
                        </div>
                        <div class="form-group columna">
                            <label>C.I.:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group columna">
                            <strong><%= user.centro %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.edad %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.ci %></strong>
                        </div>
                    </div>
                    <div class="row columna1" style="text-align: left; margin-left: 30px; margin-top: 10px;">
                        <label>Nombre:</label>
                    </div>
                    <div class="row columna1" style="text-align: left; margin-left: 30px; margin-top: 5px;">
                            <strong><%= user.nombres %></strong>
                    </div>
                    <br>
                    <div class="row">
                        <div class="form-group">
                            <label>Vacuna:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <strong><%= user.vacuna %></strong>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="form-group columna">
                            <label>Fecha 1era Dosis:</label>
                        </div>
                        <div class="form-group columna">
                            <label>Vacunador:</label>
                        </div>
                        <div class="form-group columna">
                            <label>Lote:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group columna">
                            <strong><%= user.fechaPrimeraDosis %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.vacunadorPrimeraDosis %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.lotePrimeraDosis %></strong>
                        </div>
                    </div>
                    <br><br>
                    <div class="row">
                        <div class="form-group columna">
                            <label>Fecha 2da Dosis:</label>
                        </div>
                        <div class="form-group columna">
                            <label>Vacunador:</label>
                        </div>
                        <div class="form-group columna">
                            <label>Lote:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group columna">
                            <strong><%= user.fechaSegundaDosis %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.vacunadorSegundaDosis %></strong>
                        </div>
                        <div class="form-group columna">
                            <strong><%= user.loteSegundaDosis %></strong>
                        </div>
                    </div>
                    <br><br>
                    <div class="row columna1" style="text-align: left; height: 90px; background-color: rgb(29, 134, 172);">
                        <div class="row">
                            <div class="form-group column" style="padding-left: 25px; margin-top: 30px; color: white;">
                                <label>Ministerio de Salud Pública</label>
                            </div>
                            <div class="form-group column" style="padding-left: 45px; margin-top: 15px; color: white;">
                                <img src="img/logo2.png" width="230" height="65"/>
                            </div>
                        </div>
                    </div>
                </div>
                <br><br><br><br>
                <input type="button" id="btn" value="Descargar Carnet" style="border-radius: 10px; width: 300px; height: 50px; background-color: rgb(50, 177, 205); color: white; font-size: 18px;"/>
                <div id="here-appear-theimages">
                    
                </div>
                <p id="msg" hidden>Clic derecho en la imagen para guardarla!</p>
            </center>

            <script>
                !function(a){"use strict";function b(a,b){return b=b||{},Promise.resolve(a).then(function(a){return e(a,b.filter)}).then(f).then(g).then(function(a){return b.bgcolor&&(a.style.backgroundColor=b.bgcolor),a}).then(function(b){return h(b,a.scrollWidth,a.scrollHeight)})}function c(a,b){return i(a,b||{}).then(function(a){return a.toDataURL()})}function d(a,b){return i(a,b||{}).then(n.canvasToBlob)}function e(b,c){function d(a){return a instanceof HTMLCanvasElement?n.makeImage(a.toDataURL()):a.cloneNode(!1)}function f(a,b,c){function d(a,b,c){var d=Promise.resolve();return b.forEach(function(b){d=d.then(function(){return e(b,c)}).then(function(b){b&&a.appendChild(b)})}),d}var f=a.childNodes;return 0===f.length?Promise.resolve(b):d(b,n.asArray(f),c).then(function(){return b})}function g(b,c){function d(){function d(a,b){function c(a,b){n.asArray(a).forEach(function(c){b.setProperty(c,a.getPropertyValue(c),a.getPropertyPriority(c))})}a.cssText?b.cssText=a.cssText:c(a,b)}d(a.window.getComputedStyle(b),c.style)}function e(){function d(d){function e(b,c,d){function e(a){var b=a.getPropertyValue("content");return a.cssText+" content: "+b+";"}function f(a){function b(b){return b+": "+a.getPropertyValue(b)+(a.getPropertyPriority(b)?" !important":"")}return n.asArray(a).map(b).join("; ")+";"}var g="."+b+":"+c,h=d.cssText?e(d):f(d);return a.document.createTextNode(g+"{"+h+"}")}var f=a.window.getComputedStyle(b,d),g=f.getPropertyValue("content");if(""!==g&&"none"!==g){var h=n.uid();c.className=c.className+" "+h;var i=a.document.createElement("style");i.appendChild(e(h,d,f)),c.appendChild(i)}}[":before",":after"].forEach(function(a){d(a)})}function f(){b instanceof HTMLTextAreaElement&&(c.innerHTML=b.value)}function g(){c instanceof SVGElement&&c.setAttribute("xmlns","http://www.w3.org/2000/svg")}return c instanceof Element?Promise.resolve().then(d).then(e).then(f).then(g).then(function(){return c}):c}return c&&!c(b)?Promise.resolve():Promise.resolve(b).then(d).then(function(a){return f(b,a,c)}).then(function(a){return g(b,a)})}function f(a){return p.resolveAll().then(function(b){var c=document.createElement("style");return a.appendChild(c),c.appendChild(document.createTextNode(b)),a})}function g(a){return q.inlineAll(a).then(function(){return a})}function h(a,b,c){return Promise.resolve(a).then(function(a){return a.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(a)}).then(n.escapeXhtml).then(function(a){return'<foreignObject x="0" y="0" width="100%" height="100%">'+a+"</foreignObject>"}).then(function(a){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+b+'" height="'+c+'">'+a+"</svg>"}).then(function(a){return"data:image/svg+xml;charset=utf-8,"+a})}function i(a,c){function d(a){var b=document.createElement("canvas");return b.width=a.scrollWidth,b.height=a.scrollHeight,b}return b(a,c).then(n.makeImage).then(n.delay(100)).then(function(b){var c=d(a);return c.getContext("2d").drawImage(b,0,0),c})}function j(){function b(){var a="application/font-woff",b="image/jpeg";return{woff:a,woff2:a,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:b,jpeg:b,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}function c(a){var b=/\.([^\.\/]*?)$/g.exec(a);return b?b[1]:""}function d(a){var d=c(a).toLowerCase();return b()[d]||""}function e(a){return-1!==a.search(/^(data:)/)}function f(a){return new Promise(function(b){for(var c=window.atob(a.toDataURL().split(",")[1]),d=c.length,e=new Uint8Array(d),f=0;d>f;f++)e[f]=c.charCodeAt(f);b(new Blob([e],{type:"image/png"}))})}function g(a){return a.toBlob?new Promise(function(b){a.toBlob(b)}):f(a)}function h(b,c){var d=a.document.implementation.createHTMLDocument(),e=d.createElement("base");d.head.appendChild(e);var f=d.createElement("a");return d.body.appendChild(f),e.href=c,f.href=b,f.href}function i(){var a=0;return function(){function b(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}return"u"+b()+a++}}function j(a){return new Promise(function(b,c){var d=new Image;d.onload=function(){b(d)},d.onerror=c,d.src=a})}function k(a){var b=3e4;return new Promise(function(c,d){function e(){if(4===g.readyState){if(200!==g.status)return void d(new Error("Cannot fetch resource "+a+", status: "+g.status));var b=new FileReader;b.onloadend=function(){var a=b.result.split(/,/)[1];c(a)},b.readAsDataURL(g.response)}}function f(){d(new Error("Timeout of "+b+"ms occured while fetching resource: "+a))}var g=new XMLHttpRequest;g.onreadystatechange=e,g.ontimeout=f,g.responseType="blob",g.timeout=b,g.open("GET",a,!0),g.send()})}function l(a,b){return"data:"+b+";base64,"+a}function m(a){return a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function n(a){return function(b){return new Promise(function(c){setTimeout(function(){c(b)},a)})}}function o(a){for(var b=[],c=a.length,d=0;c>d;d++)b.push(a[d]);return b}function p(a){return a.replace(/#/g,"%23").replace(/\n/g,"%0A")}return{escape:m,parseExtension:c,mimeType:d,dataAsUrl:l,isDataUrl:e,canvasToBlob:g,resolveUrl:h,getAndEncode:k,uid:i(),delay:n,asArray:o,escapeXhtml:p,makeImage:j}}function k(){function a(a){return-1!==a.search(e)}function b(a){for(var b,c=[];null!==(b=e.exec(a));)c.push(b[1]);return c.filter(function(a){return!n.isDataUrl(a)})}function c(a,b,c,d){function e(a){return new RegExp("(url\\(['\"]?)("+n.escape(a)+")(['\"]?\\))","g")}return Promise.resolve(b).then(function(a){return c?n.resolveUrl(a,c):a}).then(d||n.getAndEncode).then(function(a){return n.dataAsUrl(a,n.mimeType(b))}).then(function(c){return a.replace(e(b),"$1"+c+"$3")})}function d(d,e,f){function g(){return!a(d)}return g()?Promise.resolve(d):Promise.resolve(d).then(b).then(function(a){var b=Promise.resolve(d);return a.forEach(function(a){b=b.then(function(b){return c(b,a,e,f)})}),b})}var e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:d,shouldProcess:a,impl:{readUrls:b,inline:c}}}function l(){function a(){return b(document).then(function(a){return Promise.all(a.map(function(a){return a.resolve()}))}).then(function(a){return a.join("\n")})}function b(){function a(a){return a.filter(function(a){return a.type===CSSRule.FONT_FACE_RULE}).filter(function(a){return o.shouldProcess(a.style.getPropertyValue("src"))})}function b(a){var b=[];return a.forEach(function(a){try{n.asArray(a.cssRules||[]).forEach(b.push.bind(b))}catch(c){console.log("Error while reading CSS rules from "+a.href,c.toString())}}),b}function c(a){return{resolve:function(){var b=(a.parentStyleSheet||{}).href;return o.inlineAll(a.cssText,b)},src:function(){return a.style.getPropertyValue("src")}}}return Promise.resolve(n.asArray(document.styleSheets)).then(b).then(a).then(function(a){return a.map(c)})}return{resolveAll:a,impl:{readAll:b}}}function m(){function a(a){function b(b){return n.isDataUrl(a.src)?Promise.resolve():Promise.resolve(a.src).then(b||n.getAndEncode).then(function(b){return n.dataAsUrl(b,n.mimeType(a.src))}).then(function(b){return new Promise(function(c,d){a.onload=c,a.onerror=d,a.src=b})})}return{inline:b}}function b(c){function d(a){var b=a.style.getPropertyValue("background");return b?o.inlineAll(b).then(function(b){a.style.setProperty("background",b,a.style.getPropertyPriority("background"))}).then(function(){return a}):Promise.resolve(a)}return c instanceof Element?d(c).then(function(){return c instanceof HTMLImageElement?a(c).inline():Promise.all(n.asArray(c.childNodes).map(function(a){return b(a)}))}):Promise.resolve(c)}return{inlineAll:b,impl:{newImage:a}}}var n=j(),o=k(),p=l(),q=m();a.domtoimage={toSvg:b,toPng:c,toBlob:d,impl:{fontFaces:p,images:q,util:n,inliner:o}}}(this);
                    document.getElementById('btn').addEventListener('click', function() {
                    var node = document.getElementById('my-node');
                    domtoimage.toPng(node)
                        .then(function(dataUrl) {
                        console.log(dataUrl);
                        var img = new Image();
                        img.src = dataUrl;
                        document.getElementById("here-appear-theimages").appendChild(img);
                        document.getElementById('my-node').hidden = true;
                        document.getElementById('btn').hidden = true;
                        document.getElementById('msg').hidden = false;
                        })
                        .catch(function(error) {
                        console.error('oops, algo salio mal!', error);
                        });

                    });
            </script>
        </div>
    </main>

    <%- include('include/_footer') %>